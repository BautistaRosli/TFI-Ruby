<div class="container">
  <div class="disk-show-card">
    <div class="disk-show-info">
      <h1 class="disk-show-title"><%= @disk.name %></h1>

      <ul class="disk-details">
        <li><strong>Artista:</strong> <span class="muted"><%= @disk.author %></span></li>
        <li><strong>Año:</strong> <span class="muted"><%= @disk.year if @disk.respond_to?(:year) %></span></li>
        <li><strong>Formato:</strong> <span class="muted"><%= @disk.format %></span></li>
        <li><strong>Precio:</strong> <span class="price">$<%= @disk.unit_price %></span></li>
        <% if @disk.genres.any? %>
          <li>
            <strong>Géneros:</strong>
            <span class="muted">
              <% @disk.genres.each do |g| %>
                <span class="tag"><%= g.name %></span>
              <% end %>
            </span>
          </li>
        <% end %>
      </ul>

      <div class="disk-description">
        <h2>Descripción</h2>
        <div class="description-body">
          <%= simple_format(@disk.description || 'Sin descripción disponible') %>
        </div>
      </div>

      <div class="disk-audio">
        <h3>Audio de muestra</h3>
        <audio id="sample-audio" preload="none">
          <source src="<%= (@disk.respond_to?(:audio) && @disk.audio.attached?) ? url_for(@disk.audio) : '/samsung-sound.mp3' %>"
                  type="<%= (@disk.respond_to?(:audio) && @disk.audio.attached?) ? @disk.audio.blob.content_type : 'audio/mpeg' %>">
          Tu navegador no soporta audio.
        </audio>
        <div style="margin-top:10px">
          <button id="play-sample" type="button" class="btn-primary">Reproducir audio</button>
        </div>
      </div>

      <div class="disk-actions">
        <%= link_to 'Volver al catálogo', disk_used_index_path, class: 'btn-outline btn-gold' %>
      </div>
    </div>

    <div class="disk-show-media">
      <% if @disk.cover.attached? %>
        <div class="show-carousel" data-disk-id="<%= @disk.id %>">
          <button type="button" class="carousel-btn prev" aria-label="Anterior">‹</button>
          <div class="carousel-track">
            <div class="carousel-slide">
              <%= image_tag @disk.cover, alt: @disk.name, class: 'disk-large-img' %>
            </div>

            <% if @disk.images.attached? %>
              <% @disk.images.each do |img| %>
                <div class="carousel-slide">
                  <%= image_tag img, alt: @disk.name, class: 'disk-large-img' %>
                </div>
              <% end %>
            <% end %>
          </div>
          <button type="button" class="carousel-btn next" aria-label="Siguiente">›</button>
        </div>
      <% else %>
        <div class="disk-large-placeholder" role="img" aria-label="Disco sin portada">Disco sin portada</div>
      <% end %>
    </div>
  </div>

  <!-- Sección de Recomendaciones -->
  <% if @recommended_disks.any? %>
    <div class="recommendations-section">
      <h2 class="recommendations-title">Discos que podrían interesarte</h2>
      <div class="recommendations-grid">
        <% @recommended_disks.each do |disk| %>
          <div class="recommendation-card">
            <%= link_to disk_used_path(disk), class: "recommendation-link" do %>
              <div class="recommendation-media">
                <% if disk.cover.present? %>
                  <%= image_tag disk.cover, alt: disk.name, class: "recommendation-img" %>
                <% else %>
                  <div class="cover-placeholder recommendation-img" role="img" aria-label="Disco sin portada">Disco sin portada</div>
                <% end %>
              </div>
              <div class="recommendation-body">
                <h3 class="recommendation-title"><%= disk.name %></h3>
                <% if disk.stock.to_i <= 0 %>
                  <div class="no-stock-badge">Sin stock</div>
                <% end %>
                <% if disk.date_ingreso.present? %>
                  <p class="recommendation-year"><%= disk.date_ingreso.year %></p>
                <% end %>
                <p class="recommendation-price">$<%= disk.unit_price %></p>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
<script>
  (function(){
    function setup(){
      var btn = document.getElementById('play-sample');
      var audio = document.getElementById('sample-audio');
      if(!btn || !audio) return;
      btn.addEventListener('click', function(){
        if(audio.paused){
          audio.play();
          btn.textContent = 'Pausar audio';
        } else {
          audio.pause();
          btn.textContent = 'Reproducir audio';
        }
      });
      audio.addEventListener('ended', function(){ btn.textContent = 'Reproducir audio'; });
    }
    document.addEventListener('DOMContentLoaded', setup);
    document.addEventListener('turbo:load', setup);
  })();
</script>
