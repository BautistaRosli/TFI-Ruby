<% content_for :title, "Discos - Disquería" %>
<% content_for :page_title, "Administración de Discos" %>
<% content_for :stylesheets do %>
  <%= stylesheet_link_tag 'admin_layout', media: 'all' %>
  <%= stylesheet_link_tag 'disks', media: 'all' %>
<% end %>

<% from_sale = (params[:from] == 'sale') %>
<body class="disks-layout">
<div class="container">
  <div class="disks-hero">
    <div>
      <h1 class="title">Administración de Discos</h1>
      <p class="subtitle"><%= from_sale ? "Agregá discos al carrito de la venta" : "Gestioná discos nuevos y usados" %></p>
    </div>
  </div>

  <section class="disks-section new-disks-section">
    <div class="disks-header">
      <h2>Discos Nuevos</h2>
      <% if from_sale %>
        <div class="disks-actions">
          <%= link_to "Ver carrito", cart_admin_sales_path, class: "btn-primary" %>
        </div>
      <% end %>
    </div>
    <div class="disks-grid">
      <% @new_disks.each do |disk| %>
        <div class="disk-card">
          <% if from_sale %>
            <div class="disk-media">
              <% cover = disk.cover&.attached? ? disk.cover : disk.images.first %>
              <% if cover.present? && cover.blob.present? %>
                <%= image_tag cover, alt: disk.name, class: "disk-large-img" %>
              <% else %>
                <div class="placeholder-img">No hay imagen cargada</div>
              <% end %>
            </div>
            <div class="disk-body">
              <h3 class="disk-title"><%= disk.name %></h3>
              <div class="disk-meta"><%= disk.author.presence || '—' %></div>
              <div class="disk-meta">Stock: <%= disk.stock.to_i %></div>
            </div>
            <div class="disk-footer">
              <div class="price">$<%= number_with_precision(disk.unit_price.to_f, precision: 2) %></div>
              <div class="actions">
                <%= form_with url: add_item_admin_sales_path, method: :post, local: true, class: "disk-add-controls" do %>
                  <%= hidden_field_tag :disk_id, disk.id %>
                  <%= number_field_tag :units_sold, 1, min: 1, max: (disk.is_a?(NewDisk) ? disk.stock.to_i : 1), class: "filter-input" %>
                  <%= submit_tag "Agregar al carrito", class: "btn-primary", data: { turbo: false } %>
                <% end %>
              </div>
            </div>
          <% else %>
            <%= link_to admin_disk_path(disk), class: "card-link" do %>
              <div class="disk-media">
                <% cover = disk.cover&.attached? ? disk.cover : disk.images.first %>
                <% if cover.present? && cover.blob.present? %>
                  <%= image_tag cover, alt: disk.name, class: "disk-large-img" %>
                <% else %>
                  <div class="placeholder-img">No hay imagen cargada</div>
                <% end %>
              </div>
              <div class="disk-body">
                <h3 class="disk-title"><%= disk.name %></h3>
                <div class="disk-meta"><%= disk.author.presence || '—' %></div>
              </div>
              <div class="disk-footer">
                <div class="price">$<%= number_with_precision(disk.unit_price.to_f, precision: 2) %></div>
                <div class="actions">
                  <span class="btn-outline">Ver detalles</span>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="pagination-wrap"><%= paginate @new_disks, param_name: :new_page %></div>
  </section>

  <section class="disks-section used-disks-section" style="margin-top:32px;">
    <div class="disks-header">
      <h2>Discos Usados</h2>
      <% if from_sale %>
        <div class="disks-actions">
          <%= link_to "Ver carrito", cart_admin_sales_path, class: "btn-primary" %>
        </div>
      <% end %>
    </div>
    <div class="disks-grid">
      <% @used_disks.each do |disk| %>
        <div class="disk-card">
          <% if from_sale %>
            <div class="disk-media">
              <% cover = disk.cover&.attached? ? disk.cover : disk.images.first %>
              <% if cover.present? && cover.blob.present? %>
                <%= image_tag cover, alt: disk.name, class: "disk-large-img" %>
              <% else %>
                <div class="placeholder-img">No hay imagen cargada</div>
              <% end %>
            </div>
            <div class="disk-body">
              <h3 class="disk-title"><%= disk.name %></h3>
              <div class="disk-meta"><%= disk.author.presence || '—' %></div>
            </div>
            <div class="disk-footer">
              <div class="price">$<%= number_with_precision(disk.unit_price.to_f, precision: 2) %></div>
              <div class="actions">
                <%= form_with url: add_item_admin_sales_path, method: :post, local: true, class: "disk-add-controls" do %>
                  <%= hidden_field_tag :disk_id, disk.id %>
                  <%= number_field_tag :units_sold, 1, min: 1, max: 1, class: "filter-input" %>
                  <%= submit_tag "Agregar al carrito", class: "btn-primary", data: { turbo: false } %>
                <% end %>
              </div>
            </div>
          <% else %>
            <%= link_to admin_disk_path(disk), class: "card-link" do %>
              <div class="disk-media">
                <% cover = disk.cover&.attached? ? disk.cover : disk.images.first %>
                <% if cover.present? && cover.blob.present? %>
                  <%= image_tag cover, alt: disk.name, class: "disk-large-img" %>
                <% else %>
                  <div class="placeholder-img">No hay imagen cargada</div>
                <% end %>
              </div>
              <div class="disk-body">
                <h3 class="disk-title"><%= disk.name %></h3>
                <div class="disk-meta"><%= disk.author.presence || '—' %></div>
              </div>
              <div class="disk-footer">
                <div class="price">$<%= number_with_precision(disk.unit_price.to_f, precision: 2) %></div>
                <div class="actions">
                  <span class="btn-outline">Ver detalles</span>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
    <div class="pagination-wrap"><%= paginate @used_disks, param_name: :used_page %></div>
  </section>

  <div class="disks-hero" style="margin-top:22px;">
    <div class="actions">
      <% unless from_sale %>
        <%= link_to 'Nuevo disco', new_admin_disk_path, class: 'btn-primary' %>
      <% else %>
        <%= link_to 'Ver carrito', cart_admin_sales_path, class: 'btn-gold' %>
      <% end %>
    </div>
  </div>
</div>
</body>