<% form_url = @disk.persisted? ? admin_disk_path(@disk) : admin_disks_path %>
<% form_method = @disk.persisted? ? :patch : :post %>

<%= form_with model: @disk, url: form_url, method: form_method, local: true, html: { multipart: true }, scope: :disk do |f| %>
  <% if @disk.errors.any? %>
    <div class="errors">
      <h3><%= pluralize(@disk.errors.count, "error") %> impiden guardar</h3>
      <ul><% @disk.errors.full_messages.each { |m| %><li><%= m %></li><% } %></ul>
    </div>
  <% end %>

  <% if @disk.new_record? %>
    <div class="field">
      <%= f.label :type, "Estado" %>
      <%= f.select :type,
        options_for_select([['Nuevo','NewDisk'],['Usado','UsedDisk']], @disk.type.presence || 'NewDisk'),
        { include_blank: false },
        class: 'form-control', id: 'disk_type_select' %>
    </div>
  <% else %>
    <input type="hidden" name="disk[type]" value="<%= @disk.type %>">
  <% end %>

  <div class="field">
    <%= f.label :name, "Nombre" %>
    <%= f.text_field :name, class: 'form-control', required: true,
          pattern: "[A-Za-z0-9 \\.,\\-!\\?:;]+", title: "Evitar caracteres especiales no permitidos" %>
  </div>

  <div class="field">
    <%= f.label :author, "Autor/Artista" %>
    <%= f.text_field :author, class: 'form-control', required: true,
          pattern: "[A-Za-z0-9 \\.,\\-!\\?:;]+", title: "Evitar caracteres especiales no permitidos" %>
  </div>

  <div class="field">
    <%= f.label :description, "Descripción" %>
    <%= f.text_area :description, class: 'form-control', required: true,
          pattern: "[A-Za-z0-9 \\.,\\-!\\?:;]+", title: "Evitar caracteres especiales no permitidos" %>
  </div>

  <div class="field">
    <%= f.label :unit_price, "Precio" %>
    <%= f.number_field :unit_price, step: 0.01, min: 0.01, class: 'form-control', required: true,
          inputmode: "decimal" %>
  </div>

  <div class="field">
    <%= f.label :format, "Formato" %>
    <%= f.select :format,
      options_for_select([['Vinilo','vinilo'],['CD','CD']], @disk.format),
      { prompt: 'Seleccionar formato' },
      class: 'form-control', required: true %>
  </div>

  <div class="field" style="display:flex; gap:8px; align-items:flex-start;">
    <div style="flex:1;">
      <label for="genre_select_control">Géneros</label>

      <!-- Contenedor del control custom -->
      <div id="genre_select_control" class="genre-select">
        <button type="button" id="genre_dropdown_btn" class="btn-outline" style="width:100%; justify-content:space-between;">
          <span>Seleccionar géneros</span>
          <span>▾</span>
        </button>

        <!-- Dropdown -->
        <div id="genre_dropdown" class="genre-dropdown" style="display:none; position:absolute; z-index:20; background:#fff; border:1px solid #e2e8f0; border-radius:8px; width:100%; max-height:220px; overflow:auto; margin-top:6px;">
          <% Genre.order(:name).each do |g| %>
            <% selected = @disk.genre_ids.include?(g.id) %>
            <button type="button"
                    class="genre-option"
                    data-id="<%= g.id %>"
                    data-name="<%= g.name %>"
                    style="display:flex; justify-content:space-between; align-items:center; width:100%; padding:8px 12px; border:none; background:<%= selected ? '#f1f5f9' : 'transparent' %>; cursor:pointer;">
              <span><%= g.name %></span>
              <% if selected %><span class="muted">✓</span><% end %>
            </button>
          <% end %>
        </div>

        <!-- Chips seleccionados -->
        <div id="genre_selected_chips" class="chips" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
          <% @disk.genres.each do |g| %>
            <span class="chip" data-id="<%= g.id %>" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:16px; border:1px solid #e2e8f0; background:#fff;">
              <%= g.name %>
              <button type="button" class="chip-remove" data-id="<%= g.id %>" style="border:none; background:none; cursor:pointer;">✕</button>
            </span>
            <input type="hidden" name="disk[genre_ids][]" value="<%= g.id %>">
          <% end %>
        </div>
      </div>
      <small class="muted">Podés seleccionar uno o varios géneros del listado. Usá ✕ para quitar.</small>
    </div>

    <div>
      <%= link_to '⚙️', admin_genres_path, class: 'btn-outline', title: 'Gestionar géneros' %>
    </div>
  </div>

  <!-- Stock (solo Nuevo) -->
  <div class="field" id="stock_field">
    <%= f.label :stock, "Stock" %>
    <%= f.number_field :stock, min: 0, step: 1, class: 'form-control',
          inputmode: "numeric", required: (@disk.is_a?(NewDisk)) %>
  </div>

  <!-- Audio (solo Usado) -->
  <div class="field" id="audio_field">
    <%= f.label :audio, "Audio opcional (muestra)" %>
    <%= f.file_field :audio, accept: 'audio/*', class: 'form-control' %>
    <% if @disk.respond_to?(:audio) && @disk.audio.attached? %>
      <div style="margin-top:8px;">
        <audio controls style="width:100%; max-width:360px;">
          <source src="<%= url_for(@disk.audio) %>" type="<%= @disk.audio.blob.content_type %>">
          Tu navegador no soporta audio.
        </audio>
      </div>
    <% end %>
  </div>

  <div class="actions" style="display:flex; gap:8px; align-items:center;">
    <%= f.submit (@disk.persisted? ? 'Guardar' : 'Crear Disco'), class: 'btn-primary' %>
    <% if @disk.persisted? %>
      <%= link_to 'Gestionar imágenes', images_admin_disk_path(@disk), class: 'btn-outline' %>
    <% end %>
    <%= link_to 'Volver', admin_disks_path, class: 'btn-outline' %>
  </div>
<% end %>

<style>
  .genre-select { position: relative; }
  .chip-remove:hover { color: #dc2626; }
</style>

<script>
  (function() {
    function currentType() {
      var select = document.getElementById('disk_type_select');
      if (select) return select.value;
      return "<%= @disk.type.presence || 'NewDisk' %>";
    }
    function toggleFields() {
      var type = currentType();
      var stockField = document.getElementById('stock_field');
      var audioField = document.getElementById('audio_field');
      if (!stockField || !audioField) return;
      if (type === 'NewDisk') {
        stockField.style.display = '';
        audioField.style.display = 'none';
      } else {
        stockField.style.display = 'none';
        audioField.style.display = '';
      }
    }
    // Sanitizar inputs de texto
    function sanitizeText(e) {
      var allowed = /[A-Za-z0-9 \.\,\-\!\?\:\;]/;
      var v = e.target.value;
      e.target.value = v.split('').filter(function(ch){ return allowed.test(ch); }).join('');
    }
    function sanitizeNumber(e) {
      var isPrice = e.target.name.endsWith('[unit_price]');
      var allowed = isPrice ? /[0-9\.]/ : /[0-9]/;
      var v = e.target.value;
      e.target.value = v.split('').filter(function(ch){ return allowed.test(ch); }).join('');
    }

    document.addEventListener('DOMContentLoaded', function(){
      toggleFields();
      var textIds = ['disk_name','disk_author','disk_description'];
      textIds.forEach(function(id){
        var el = document.getElementById(id);
        if (el) el.addEventListener('input', sanitizeText);
      });
      var price = document.getElementById('disk_unit_price');
      if (price) price.addEventListener('input', sanitizeNumber);
      var stock = document.getElementById('disk_stock');
      if (stock) stock.addEventListener('input', sanitizeNumber);
    });
    document.addEventListener('turbo:load', toggleFields);
    document.addEventListener('change', function(e) {
      if (e.target && e.target.id === 'disk_type_select') toggleFields();
    });
  })();

  (function(){
    function qs(id){ return document.getElementById(id); }
    function createChip(id, name){
      var chip = document.createElement('span');
      chip.className = 'chip';
      chip.dataset.id = String(id);
      chip.style.cssText = 'display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:16px;border:1px solid #e2e8f0;background:#fff;';
      chip.innerHTML = name + ' <button type="button" class="chip-remove" data-id="'+id+'" style="border:none;background:none;cursor:pointer;">✕</button>';
      return chip;
    }
    function createHidden(id){
      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'disk[genre_ids][]';
      input.value = String(id);
      return input;
    }
    function selectedIds(container){
      return Array.from(container.querySelectorAll('input[name="disk[genre_ids][]"]')).map(function(i){ return Number(i.value); });
    }

    function setup(){
      var btn = qs('genre_dropdown_btn');
      var dd = qs('genre_dropdown');
      var chips = qs('genre_selected_chips');
      if(!btn || !dd || !chips) return;

      // Toggle dropdown
      btn.addEventListener('click', function(){
        dd.style.display = (dd.style.display === 'none' || dd.style.display === '') ? 'block' : 'none';
      });

      // Cerrar al click fuera
      document.addEventListener('click', function(e){
        if(!dd.contains(e.target) && !btn.contains(e.target)) dd.style.display = 'none';
      });

      // Seleccionar género
      dd.addEventListener('click', function(e){
        var option = e.target.closest('.genre-option');
        if(!option) return;
        var id = Number(option.dataset.id);
        var name = option.dataset.name;
        var ids = selectedIds(chips);
        if(ids.includes(id)){
          // ya seleccionado → quitar
          Array.from(chips.querySelectorAll('.chip')).forEach(function(c){
            if(Number(c.dataset.id) === id) c.remove();
          });
          Array.from(chips.querySelectorAll('input[name="disk[genre_ids][]"]')).forEach(function(h){
            if(Number(h.value) === id) h.remove();
          });
          option.style.background = 'transparent';
        } else {
          // agregar
          chips.appendChild(createChip(id, name));
          chips.appendChild(createHidden(id));
          option.style.background = '#f1f5f9';
        }
        // cerrar dropdown tras seleccionar
        dd.style.display = 'none';
      });

      // Quitar género desde chip
      chips.addEventListener('click', function(e){
        var btnRemove = e.target.closest('.chip-remove');
        if(!btnRemove) return;
        var id = Number(btnRemove.dataset.id);
        // quitar chip + hidden
        Array.from(chips.querySelectorAll('.chip')).forEach(function(c){
          if(Number(c.dataset.id) === id) c.remove();
        });
        Array.from(chips.querySelectorAll('input[name="disk[genre_ids][]"]')).forEach(function(h){
          if(Number(h.value) === id) h.remove();
        });
        // desmarcar en dropdown
        Array.from(dd.querySelectorAll('.genre-option')).forEach(function(opt){
          if(Number(opt.dataset.id) === id) opt.style.background = 'transparent';
        });
      });
    }

    document.addEventListener('DOMContentLoaded', setup);
    document.addEventListener('turbo:load', setup);
  })();
</script>